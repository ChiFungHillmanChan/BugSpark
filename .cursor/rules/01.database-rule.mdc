---
description: Database rules — SQLAlchemy ORM + Alembic migrations for the FastAPI backend
globs: *.py
alwaysApply: true
---

## Database Stack

- **ORM**: SQLAlchemy 2.x with async support (`sqlalchemy.ext.asyncio`)
- **Migrations**: Alembic
- **Database**: PostgreSQL (production)
- **Models**: Located in `packages/api/app/models/`
- **Schemas** (Pydantic): Located in `packages/api/app/schemas/`

## Migration Rules

### Running Migrations

Always run migrations with the project's virtual environment activated:

```bash
cd /Users/hillmanchan/Desktop/BugSpark/packages/api && source .venv/bin/activate && alembic upgrade head
```

- Do **NOT** use `pnpm db:migrate` from the root — it may pick up the system Python which lacks project dependencies.
- Do **NOT** use `alembic` without activating `.venv` first.

### Creating Migrations

- Migration files live in `packages/api/migrations/versions/`.
- Use a descriptive slug-style revision ID (e.g., `j1k2l3m4n5o6_add_console_logs_included.py`).
- Each migration must set `down_revision` to the previous latest revision.
- Always include both `upgrade()` and `downgrade()` functions.
- After creating a migration file, run the migration command above to apply it.

### Schema Changes Workflow

1. Edit the SQLAlchemy model in `packages/api/app/models/`.
2. Create a new Alembic migration file in `packages/api/migrations/versions/`.
3. Update the corresponding Pydantic schema in `packages/api/app/schemas/` if the field is exposed via the API.
4. Run: `cd /Users/hillmanchan/Desktop/BugSpark/packages/api && source .venv/bin/activate && alembic upgrade head`
5. Remind the user to run the migration if they haven't already.

## SQLAlchemy Model Guidelines

- Use `Mapped[]` type annotations with `mapped_column()` (SQLAlchemy 2.x style).
- Always set `server_default` for columns with defaults so the DB enforces them.
- Use `UUID(as_uuid=True)` for UUID primary keys.
- Use `JSONB` for JSON columns (PostgreSQL).
- Define relationships with `lazy="selectin"` for eagerly-loaded relations.

## Pydantic Schema Guidelines

- Use `CamelModel` (from `app.schemas`) for API responses to auto-convert snake_case → camelCase.
- Use plain `BaseModel` for request bodies (they accept camelCase via `alias`).
- Import types from SQLAlchemy models when possible — do not duplicate field definitions manually.
