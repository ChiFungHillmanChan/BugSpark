# 1.3 Open AI Analysis to Team Plan Users

## Priority: HIGH

AI analysis is BugSpark's strongest differentiator, but it is currently gated to Enterprise plan + superadmin only. This severely limits its value. It should be available to Team plan users (and later, Starter with limits).

---

## Current State

In `packages/api/app/routers/analysis.py`, the analysis endpoints check:
1. User must be authenticated (`get_active_user`)
2. User must have `superadmin` role OR enterprise plan

This means even Team plan paying customers cannot use AI analysis.

## Changes Required

### 1. Update Analysis Router Access Control

```python
# packages/api/app/routers/analysis.py

# Before: Only superadmin/enterprise
async def analyze_report(
    report_id: str,
    db: AsyncSession = Depends(get_db_session),
    current_user: User = Depends(require_superadmin),  # TOO RESTRICTIVE
):

# After: Team plan and above
from app.dependencies import require_plan

async def analyze_report(
    report_id: str,
    db: AsyncSession = Depends(get_db_session),
    current_user: User = Depends(get_active_user),
):
    # Check plan access
    allowed_plans = {"team", "enterprise"}
    if current_user.plan not in allowed_plans and current_user.role != "superadmin":
        raise ForbiddenException("AI analysis requires Team plan or above")
```

### 2. Add Rate Limiting Per Plan

```python
# Add plan-based rate limiting for AI analysis
PLAN_AI_LIMITS = {
    "starter": 20,   # 20 analyses per month (future)
    "team": 200,      # 200 analyses per month
    "enterprise": -1,  # unlimited
}

async def check_ai_quota(db: AsyncSession, user: User) -> bool:
    """Check if user has remaining AI analysis quota for current month."""
    if user.role == "superadmin" or user.plan == "enterprise":
        return True

    limit = PLAN_AI_LIMITS.get(user.plan, 0)
    if limit == 0:
        return False

    # Count analyses this month
    start_of_month = datetime.utcnow().replace(day=1, hour=0, minute=0, second=0)
    count = await db.scalar(
        select(func.count(AnalysisLog.id))
        .where(AnalysisLog.user_id == user.id)
        .where(AnalysisLog.created_at >= start_of_month)
    )
    return count < limit
```

### 3. Add Analysis Log Model

Create `packages/api/app/models/analysis_log.py`:

```python
class AnalysisLog(Base):
    __tablename__ = "analysis_logs"

    id = Column(UUID, primary_key=True, default=uuid4)
    user_id = Column(UUID, ForeignKey("users.id"), nullable=False)
    report_id = Column(UUID, ForeignKey("reports.id"), nullable=False)
    tokens_used = Column(Integer, default=0)
    created_at = Column(DateTime, default=datetime.utcnow)
```

### 4. Create Alembic Migration

```bash
cd packages/api
alembic revision --autogenerate -m "add analysis_logs table"
```

### 5. Update Dashboard AI Panel

In `packages/dashboard/src/components/bug-detail/ai-analysis-panel.tsx`:
- Remove any client-side enterprise/superadmin gating
- Show quota usage: "15/200 analyses used this month"
- Show upgrade prompt if on Free/Starter plan

### 6. Update API Response

Add quota info to analysis response:

```python
class AnalysisResponseWithQuota(AnalysisResponse):
    quota_used: int
    quota_limit: int  # -1 for unlimited
    quota_remaining: int
```

## Implementation Steps

1. Create `AnalysisLog` model
2. Create Alembic migration
3. Add `check_ai_quota` function in a new `app/services/ai_quota_service.py`
4. Update analysis router to use plan-based access instead of superadmin-only
5. Log each analysis in `analysis_logs` table
6. Return quota info in analysis response
7. Update dashboard to show quota and remove enterprise gate
8. Add tests for plan-based access and quota enforcement

## Tests to Add

- `test_team_plan_user_can_analyze` — Team plan user gets 200 OK
- `test_free_plan_user_cannot_analyze` — Free plan user gets 403
- `test_analysis_quota_enforced` — After N analyses, next one is rejected
- `test_superadmin_bypasses_quota` — Superadmin always gets through
- `test_quota_resets_monthly` — Quota count resets at month start
