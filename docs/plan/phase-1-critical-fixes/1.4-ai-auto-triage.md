# 1.4 AI Auto-Triage on Report Submit

## Priority: HIGH

Currently, AI analysis must be triggered manually from the dashboard. Competitors like Jam.dev auto-generate titles, descriptions, and repro steps on submit. BugSpark should auto-triage reports in the background when they are created.

---

## Current State

- Report is created via `POST /reports`
- User must manually click "Analyze" button on bug detail page
- Analysis runs synchronously (or via SSE stream)

## Target Behavior

1. User submits bug report via widget
2. API creates the report and returns immediately (202 or 201)
3. Background task runs AI analysis automatically
4. Analysis results are saved to the report
5. Dashboard shows analysis when user views the report (no manual trigger needed)
6. If the user's plan doesn't include AI, skip auto-triage

## Changes Required

### 1. Add Auto-Triage Background Task

Create `packages/api/app/services/auto_triage_service.py`:

```python
from app.services.ai_analysis_service import analyze_report
from app.services.ai_quota_service import check_ai_quota, log_analysis

async def auto_triage_report(report_id: str, user_id: str):
    """Background task: run AI analysis on a newly created report."""
    async with get_db_session_context() as db:
        user = await get_user_by_id(db, user_id)
        if not user:
            return

        # Check if user's plan allows auto-triage
        if user.plan not in ("starter", "team", "enterprise") and user.role != "superadmin":
            return

        # Check quota
        if not await check_ai_quota(db, user):
            return

        report = await get_report_by_id(db, report_id)
        if not report:
            return

        # Run analysis
        analysis = await analyze_report(db, report)

        # Save results to report
        report.ai_summary = analysis.summary
        report.ai_category = analysis.suggested_category
        report.ai_severity = analysis.suggested_severity
        report.ai_root_cause = analysis.root_cause
        report.ai_fix_suggestions = analysis.fix_suggestions
        report.ai_affected_area = analysis.affected_area
        report.ai_reproduction_steps = analysis.reproduction_steps
        report.ai_analyzed_at = datetime.utcnow()

        await db.commit()
        await log_analysis(db, user.id, report.id)
```

### 2. Add AI Fields to Report Model

Add columns to the `Report` model:

```python
# packages/api/app/models/report.py
ai_summary = Column(Text, nullable=True)
ai_category = Column(String(50), nullable=True)
ai_severity = Column(String(50), nullable=True)
ai_root_cause = Column(Text, nullable=True)
ai_fix_suggestions = Column(JSON, nullable=True)  # list[str]
ai_affected_area = Column(String(200), nullable=True)
ai_reproduction_steps = Column(JSON, nullable=True)  # list[str]
ai_analyzed_at = Column(DateTime, nullable=True)
```

### 3. Trigger Auto-Triage on Report Creation

In `packages/api/app/routers/reports.py`, after creating the report:

```python
from fastapi import BackgroundTasks

@router.post("/reports")
async def create_report(
    ...,
    background_tasks: BackgroundTasks,
):
    # ... existing report creation logic ...

    # Trigger auto-triage in background
    project_owner = await get_project_owner(db, report.project_id)
    if project_owner:
        background_tasks.add_task(
            auto_triage_report,
            report_id=str(report.id),
            user_id=str(project_owner.id),
        )

    return report
```

### 4. Update Report Schema

In `packages/api/app/schemas/report.py`:

```python
class ReportResponse(CamelModel):
    # ... existing fields ...

    # AI triage results
    ai_summary: str | None = None
    ai_category: str | None = None
    ai_severity: str | None = None
    ai_root_cause: str | None = None
    ai_fix_suggestions: list[str] | None = None
    ai_affected_area: str | None = None
    ai_reproduction_steps: list[str] | None = None
    ai_analyzed_at: datetime | None = None
```

### 5. Update Dashboard Bug Detail

In `packages/dashboard/src/components/bug-detail/ai-analysis-panel.tsx`:

```typescript
// Show auto-triage results if available
// If report.aiAnalyzedAt exists, show the saved analysis
// If not, show "Analyzing..." spinner or manual trigger button
// Still allow manual re-analysis via button
```

### 6. Plan-Based Auto-Triage Levels

| Plan | Auto-Triage Level |
|------|-------------------|
| Free | None |
| Starter | Basic: auto-suggest title + category only |
| Pro | Full: all AI fields |
| Team | Full: all AI fields |
| Enterprise | Full: all AI fields |

For Starter "basic" mode, use a shorter/cheaper prompt that only returns `summary`, `suggestedCategory`, and `suggestedSeverity`.

## Implementation Steps

1. Create Alembic migration adding AI columns to `reports` table
2. Update `Report` model with new columns
3. Update `ReportResponse` schema with new fields
4. Create `auto_triage_service.py`
5. Modify report creation endpoint to trigger background auto-triage
6. Update dashboard to display auto-triage results inline
7. Keep manual "Re-analyze" button for refreshing analysis
8. Add plan-level gating (basic vs full)

## Tests to Add

- `test_report_creation_triggers_auto_triage` — Verify background task is queued
- `test_auto_triage_saves_results_to_report` — AI results stored in report
- `test_auto_triage_respects_plan_limits` — Free plan skips, Starter gets basic
- `test_auto_triage_respects_quota` — Stops when monthly quota exceeded
- `test_manual_reanalyze_overwrites_auto_triage` — Manual trigger replaces saved results

## Cost Impact

- Each auto-triage uses ~2K input + 1K output tokens
- At Sonnet 3.5 pricing: ~US$0.02 per analysis
- 1,000 reports/month = ~US$20/month in AI costs
- Basic mode (Starter) uses ~500 input + 200 output = ~US$0.004 per analysis
