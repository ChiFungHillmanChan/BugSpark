# 1.5 Email Notification System

## Priority: HIGH

Email notifications are a basic expectation. Users should not have to check the dashboard constantly to know about new bugs or status changes.

---

## Current State

- Resend is already configured for email verification and password reset
- `packages/api/app/services/email_service.py` exists with basic send capability
- No notification emails for bug reports, comments, or status changes

## Notification Types to Implement

| Event | Recipients | Content |
|-------|-----------|---------|
| New bug report | All project members | Title, severity badge, screenshot thumbnail, link |
| Status change | Report creator + assignee | Old status â†’ new status, who changed it |
| New comment | Report creator + all commenters | Comment text, commenter name, link |
| Comment mention (@user) | Mentioned user | Comment text, context, link |
| AI analysis complete | Report assignee (or creator) | Summary, severity suggestion, link |
| Weekly digest | All active project members | Report count, severity breakdown, unresolved count |

## Architecture

### 1. Notification Preference Model

Create `packages/api/app/models/notification_preference.py`:

```python
class NotificationPreference(Base):
    __tablename__ = "notification_preferences"

    id = Column(UUID, primary_key=True, default=uuid4)
    user_id = Column(UUID, ForeignKey("users.id"), unique=True, nullable=False)

    # Per-event toggles
    email_new_report = Column(Boolean, default=True)
    email_status_change = Column(Boolean, default=True)
    email_new_comment = Column(Boolean, default=True)
    email_mention = Column(Boolean, default=True)
    email_ai_analysis = Column(Boolean, default=True)
    email_weekly_digest = Column(Boolean, default=True)

    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, onupdate=datetime.utcnow)
```

### 2. Notification Service

Create `packages/api/app/services/email_notification_service.py`:

```python
from app.services.email_service import send_email

async def notify_new_report(db: AsyncSession, report: Report):
    """Send email to project members about a new bug report."""
    members = await get_project_members(db, report.project_id)
    for member in members:
        prefs = await get_notification_prefs(db, member.user_id)
        if prefs and not prefs.email_new_report:
            continue

        await send_email(
            to=member.user.email,
            subject=f"[{report.project.name}] New bug: {report.title}",
            html=render_template("new_report", {
                "report": report,
                "project": report.project,
                "dashboard_url": settings.FRONTEND_URL,
            }),
        )

async def notify_status_change(db, report, old_status, new_status, changed_by):
    ...

async def notify_new_comment(db, report, comment):
    ...

async def notify_mention(db, report, comment, mentioned_user):
    ...
```

### 3. Email Templates

Create HTML email templates in `packages/api/app/templates/emails/`:

```
emails/
  base.html          -- shared layout (logo, footer, unsubscribe link)
  new_report.html     -- new bug report notification
  status_change.html  -- status change notification
  new_comment.html    -- new comment notification
  mention.html        -- @mention notification
  ai_analysis.html    -- AI analysis complete
  weekly_digest.html  -- weekly summary
```

Each template should:
- Use the shared base layout
- Escape all user-provided content (use `markupsafe.escape`)
- Include a direct link to the report in the dashboard
- Include an unsubscribe link
- Be mobile-responsive
- Support both light and dark email clients

### 4. Trigger Points

Add notification calls to existing routers:

**Reports router (`reports.py`):**
```python
# After creating report:
background_tasks.add_task(notify_new_report, db_session_factory, report.id)

# After updating report status:
if "status" in update_fields:
    background_tasks.add_task(
        notify_status_change, db_session_factory,
        report.id, old_status, new_status, current_user.id
    )
```

**Comments router (`comments.py`):**
```python
# After creating comment:
background_tasks.add_task(notify_new_comment, db_session_factory, report.id, comment.id)

# Check for @mentions in comment text:
mentioned_users = extract_mentions(comment.content)
for user_id in mentioned_users:
    background_tasks.add_task(notify_mention, db_session_factory, report.id, comment.id, user_id)
```

### 5. Notification Settings UI

Add to dashboard settings page (`/settings/notifications`):

```typescript
// Toggle switches for each notification type
// "Email me when..."
// [ ] New bug report in my projects
// [ ] Bug status changes
// [ ] Someone comments on my reports
// [ ] Someone mentions me
// [ ] AI analysis completes
// [ ] Weekly digest summary
```

### 6. API Endpoints

```
GET  /api/v1/notifications/preferences    -- Get current preferences
PUT  /api/v1/notifications/preferences    -- Update preferences
POST /api/v1/notifications/unsubscribe    -- Unsubscribe via email link (token-based)
```

## Implementation Steps

1. Create `NotificationPreference` model
2. Create Alembic migration
3. Create email templates (HTML)
4. Create `email_notification_service.py`
5. Add `extract_mentions` utility for @mention parsing
6. Add notification triggers to reports and comments routers (as background tasks)
7. Add notification preferences API endpoints
8. Add notification settings page to dashboard
9. Add unsubscribe flow (token in email link)
10. Add weekly digest cron job (can use APScheduler or external cron)

## Plan Gating

| Plan | Notifications |
|------|--------------|
| Free | New report only (max 5/day) |
| Starter | All notifications |
| Pro | All notifications |
| Team | All notifications + weekly digest |
| Enterprise | All + custom digest frequency |

## Tests to Add

- `test_new_report_sends_email_to_members`
- `test_status_change_sends_email`
- `test_comment_sends_email`
- `test_mention_sends_email_to_mentioned_user`
- `test_notification_respects_user_preferences`
- `test_unsubscribe_link_works`
- `test_email_escapes_html_content`
- `test_free_plan_rate_limited`
