# 2.1 Jira Integration (2-Way Sync)

## Priority: HIGH

Jira is the most widely used project management tool. Marker.io's strongest selling point is deep Jira 2-way sync. Small companies using Jira Free (up to 10 users) will not adopt BugSpark without it.

---

## Feature Scope

### Export (BugSpark → Jira)
- Create Jira issue from bug report
- Map BugSpark severity → Jira priority
- Include formatted report content (title, description, screenshot, logs)
- Set Jira labels ("bug" + severity)
- Return Jira issue key (e.g., "PROJ-123") and URL

### Sync (Jira → BugSpark)
- Jira issue status change → update BugSpark report status
- Jira issue comment → sync to BugSpark comments
- Jira issue resolved/closed → auto-resolve BugSpark report

## Architecture

### Backend Files to Create/Modify

```
packages/api/
  app/
    services/
      jira_integration.py          # NEW — Jira REST API client
    routers/
      integrations.py              # MODIFY — add Jira-specific endpoints
      webhooks.py                  # MODIFY — add Jira webhook receiver
    schemas/
      integration.py               # MODIFY — add Jira config validation
```

### Jira REST API Integration

```python
# packages/api/app/services/jira_integration.py

import httpx

class JiraClient:
    def __init__(self, domain: str, email: str, api_token: str):
        self.base_url = f"https://{domain}.atlassian.net/rest/api/3"
        self.auth = (email, api_token)

    async def create_issue(self, project_key: str, report: Report) -> dict:
        payload = {
            "fields": {
                "project": {"key": project_key},
                "summary": report.title,
                "description": self._format_description(report),
                "issuetype": {"name": "Bug"},
                "priority": {"name": SEVERITY_TO_PRIORITY[report.severity]},
                "labels": ["bugspark", report.severity],
            }
        }
        async with httpx.AsyncClient() as client:
            response = await client.post(
                f"{self.base_url}/issue",
                json=payload,
                auth=self.auth,
            )
            response.raise_for_status()
            data = response.json()
            return {
                "issue_key": data["key"],
                "issue_id": data["id"],
                "issue_url": f"https://{self.domain}.atlassian.net/browse/{data['key']}",
            }

SEVERITY_TO_PRIORITY = {
    "critical": "Highest",
    "high": "High",
    "medium": "Medium",
    "low": "Low",
}
```

### Jira Webhook Receiver

```python
# Add to webhooks router or create dedicated jira_webhook router

@router.post("/webhooks/jira/{project_id}")
async def receive_jira_webhook(
    project_id: str,
    payload: dict,
    db: AsyncSession = Depends(get_db_session),
):
    """Receive Jira webhook events and update BugSpark reports."""
    event = payload.get("webhookEvent")

    if event == "jira:issue_updated":
        issue_key = payload["issue"]["key"]
        changelog = payload.get("changelog", {})

        for item in changelog.get("items", []):
            if item["field"] == "status":
                new_status = item["toString"]
                await sync_jira_status_to_bugspark(db, project_id, issue_key, new_status)

    elif event == "comment_created":
        issue_key = payload["issue"]["key"]
        comment_body = payload["comment"]["body"]
        await sync_jira_comment_to_bugspark(db, project_id, issue_key, comment_body)
```

### Jira Status Mapping

```python
JIRA_TO_BUGSPARK_STATUS = {
    "To Do": "new",
    "In Progress": "in_progress",
    "In Review": "in_progress",
    "Done": "resolved",
    "Closed": "closed",
    "Won't Do": "closed",
}
```

### Integration Config Schema

```python
# Update packages/api/app/schemas/integration.py

JIRA_REQUIRED_KEYS = {"domain", "email", "apiToken", "projectKey"}

# In SUPPORTED_PROVIDERS validation:
SUPPORTED_PROVIDERS = {"github", "linear", "jira"}

def validate_config(provider: str, config: dict):
    if provider == "jira":
        missing = JIRA_REQUIRED_KEYS - set(config.keys())
        if missing:
            raise BadRequestException(f"Missing Jira config keys: {missing}")
```

### Dashboard Integration Form

Create `packages/dashboard/src/components/settings/jira-integration-form.tsx`:

Fields:
- Jira Domain (e.g., `mycompany` for `mycompany.atlassian.net`)
- Email (Jira account email)
- API Token (from https://id.atlassian.com/manage-profile/security/api-tokens)
- Project Key (e.g., "PROJ")
- Test Connection button
- Enable 2-way sync toggle

### Export Button

Update `packages/dashboard/src/components/bug-detail/export-to-tracker.tsx`:
- Add "Export to Jira" button alongside GitHub and Linear
- Show Jira issue key (e.g., "PROJ-123") after export

## Implementation Steps

1. Create `jira_integration.py` service
2. Add Jira config validation to integration schema
3. Add Jira webhook receiver endpoint
4. Create status mapping logic
5. Create dashboard Jira integration form
6. Add "Export to Jira" button to bug detail page
7. Add Jira webhook registration instructions in docs
8. Create `report.jira_issue_key` and `report.jira_issue_url` columns
9. Add i18n keys for Jira-related UI text
10. Update pricing page to show Jira as available (not "Coming Soon")

## Tests to Add

- `test_jira_create_issue` — Creates issue with correct payload
- `test_jira_severity_mapping` — Maps BugSpark severity to Jira priority
- `test_jira_webhook_status_sync` — Status change syncs back
- `test_jira_webhook_comment_sync` — Comment syncs back
- `test_jira_config_validation` — Missing keys rejected
- `test_jira_export_stores_issue_key` — Issue key saved to report

## Security Considerations

- Jira API token stored encrypted in DB (same pattern as GitHub/Linear tokens)
- Webhook endpoint validates project ownership
- Jira webhook signature verification (if available)
- Rate limit webhook endpoint to prevent abuse
