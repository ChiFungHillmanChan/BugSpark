# 2.2 Slack & Discord Notifications

## Priority: HIGH

Every major competitor has Slack integration. Small dev teams live in Slack/Discord and expect real-time bug notifications in their channels.

---

## Feature Scope

### MVP (Incoming Webhooks)
- Configure a Slack Incoming Webhook URL or Discord Webhook URL per project
- New bug report → rich message posted to channel
- Status change → message posted to channel
- AI analysis complete → summary posted to channel

### Future (Slack App)
- Interactive buttons in Slack (change status, assign, view details)
- Slash commands (`/bugspark list`, `/bugspark resolve #123`)
- Thread replies sync to BugSpark comments

## Architecture

### Notification Channel Model

Add to integration config or create a dedicated model:

```python
# Option A: Use existing integration model with provider="slack" or "discord"
# This is simpler and consistent with GitHub/Linear pattern

# Integration config for Slack:
{
    "provider": "slack",
    "config": {
        "webhookUrl": "https://hooks.slack.com/services/T.../B.../xxx",
        "channel": "#bugs",  # Display only, not used in webhook
        "notifyOn": ["report.created", "report.status_changed", "analysis.completed"]
    }
}

# Integration config for Discord:
{
    "provider": "discord",
    "config": {
        "webhookUrl": "https://discord.com/api/webhooks/123/abc",
        "notifyOn": ["report.created", "report.status_changed"]
    }
}
```

### Slack Message Service

Create `packages/api/app/services/slack_notification_service.py`:

```python
import httpx

SEVERITY_EMOJI = {
    "critical": ":red_circle:",
    "high": ":orange_circle:",
    "medium": ":large_yellow_circle:",
    "low": ":white_circle:",
}

async def send_slack_notification(webhook_url: str, report: Report, event: str):
    if event == "report.created":
        payload = {
            "blocks": [
                {
                    "type": "header",
                    "text": {"type": "plain_text", "text": f"New Bug Report: {report.title}"}
                },
                {
                    "type": "section",
                    "fields": [
                        {"type": "mrkdwn", "text": f"*Severity:* {SEVERITY_EMOJI[report.severity]} {report.severity}"},
                        {"type": "mrkdwn", "text": f"*Category:* {report.category}"},
                        {"type": "mrkdwn", "text": f"*Project:* {report.project.name}"},
                        {"type": "mrkdwn", "text": f"*Reporter:* {report.reporter_email or 'Anonymous'}"},
                    ]
                },
                {
                    "type": "section",
                    "text": {"type": "mrkdwn", "text": report.description[:500] if report.description else "_No description_"}
                },
                {
                    "type": "actions",
                    "elements": [
                        {
                            "type": "button",
                            "text": {"type": "plain_text", "text": "View in BugSpark"},
                            "url": f"{settings.FRONTEND_URL}/bugs/{report.id}"
                        }
                    ]
                }
            ]
        }

    async with httpx.AsyncClient() as client:
        await client.post(webhook_url, json=payload, timeout=10)
```

### Discord Message Service

Create `packages/api/app/services/discord_notification_service.py`:

```python
SEVERITY_COLOR = {
    "critical": 0xDC2626,  # red
    "high": 0xEA580C,      # orange
    "medium": 0xCA8A04,    # yellow
    "low": 0x16A34A,       # green
}

async def send_discord_notification(webhook_url: str, report: Report, event: str):
    if event == "report.created":
        payload = {
            "embeds": [{
                "title": f"New Bug: {report.title}",
                "description": (report.description or "")[:500],
                "color": SEVERITY_COLOR.get(report.severity, 0x6B7280),
                "fields": [
                    {"name": "Severity", "value": report.severity, "inline": True},
                    {"name": "Category", "value": report.category, "inline": True},
                    {"name": "Project", "value": report.project.name, "inline": True},
                ],
                "url": f"{settings.FRONTEND_URL}/bugs/{report.id}",
                "timestamp": report.created_at.isoformat(),
            }]
        }

    async with httpx.AsyncClient() as client:
        await client.post(webhook_url, json=payload, timeout=10)
```

### Integration with Existing Event System

Add to the report creation and update flows:

```python
# In reports router, after creating/updating report:
async def dispatch_channel_notifications(
    db: AsyncSession,
    report: Report,
    event: str,
    background_tasks: BackgroundTasks,
):
    integrations = await get_project_integrations(db, report.project_id)
    for integration in integrations:
        if event not in integration.config.get("notifyOn", []):
            continue

        if integration.provider == "slack":
            background_tasks.add_task(
                send_slack_notification,
                integration.config["webhookUrl"],
                report,
                event,
            )
        elif integration.provider == "discord":
            background_tasks.add_task(
                send_discord_notification,
                integration.config["webhookUrl"],
                report,
                event,
            )
```

### Dashboard Integration Forms

Create:
- `packages/dashboard/src/components/settings/slack-integration-form.tsx`
- `packages/dashboard/src/components/settings/discord-integration-form.tsx`

Fields for Slack:
- Webhook URL (with link to Slack webhook creation docs)
- Events to notify on (checkboxes)
- Test button (sends sample message)

Fields for Discord:
- Webhook URL (with link to Discord webhook creation docs)
- Events to notify on (checkboxes)
- Test button

### Update Supported Providers

```python
# packages/api/app/schemas/integration.py
SUPPORTED_PROVIDERS = {"github", "linear", "jira", "slack", "discord"}

SLACK_REQUIRED_KEYS = {"webhookUrl"}
DISCORD_REQUIRED_KEYS = {"webhookUrl"}
```

## Implementation Steps

1. Add "slack" and "discord" to `SUPPORTED_PROVIDERS`
2. Add config validation for Slack/Discord webhook URLs
3. Create `slack_notification_service.py`
4. Create `discord_notification_service.py`
5. Create `dispatch_channel_notifications` utility
6. Add notification dispatch to report creation and update flows
7. Create Slack integration form in dashboard
8. Create Discord integration form in dashboard
9. Add "Test" button that sends a sample notification
10. Add i18n keys for Slack/Discord UI
11. Update pricing page

## Tests to Add

- `test_slack_webhook_sends_on_new_report`
- `test_discord_webhook_sends_on_new_report`
- `test_notification_respects_event_filter`
- `test_slack_message_format_correct`
- `test_discord_embed_format_correct`
- `test_webhook_url_validation`
- `test_notification_failure_does_not_block_report_creation`

## Security Considerations

- Validate webhook URLs (must be `https://hooks.slack.com/...` or `https://discord.com/api/webhooks/...`)
- Store webhook URLs encrypted
- Rate limit notification dispatch (prevent abuse if many reports created rapidly)
- Webhook failures should be logged but never block report creation
