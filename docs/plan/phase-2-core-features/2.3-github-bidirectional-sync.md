# 2.3 GitHub Bidirectional Sync

## Priority: MEDIUM

Currently BugSpark only exports to GitHub (one-way). Marker.io's killer feature is 2-way sync with project management tools. Adding GitHub → BugSpark sync creates a seamless workflow.

---

## Feature Scope

### Current (One-Way: BugSpark → GitHub)
- Export bug report as GitHub issue (already working)

### New (Two-Way: GitHub → BugSpark)
- GitHub issue status change → update BugSpark report status
- GitHub issue label change → update BugSpark severity/category
- GitHub issue comment → sync to BugSpark comments
- GitHub issue closed → auto-resolve BugSpark report
- GitHub issue reopened → reopen BugSpark report

## Architecture

### GitHub Webhook Receiver

Create `packages/api/app/routers/github_webhook.py`:

```python
import hashlib
import hmac
from fastapi import APIRouter, Request, Header

router = APIRouter(prefix="/webhooks/github", tags=["github-webhook"])

@router.post("/{project_id}")
async def receive_github_webhook(
    project_id: str,
    request: Request,
    x_hub_signature_256: str = Header(None),
    x_github_event: str = Header(None),
    db: AsyncSession = Depends(get_db_session),
):
    body = await request.body()

    # Verify webhook signature
    integration = await get_github_integration(db, project_id)
    if not integration or not integration.config.get("webhookSecret"):
        raise UnauthorizedException("Webhook not configured")

    expected_sig = "sha256=" + hmac.new(
        integration.config["webhookSecret"].encode(),
        body,
        hashlib.sha256,
    ).hexdigest()

    if not hmac.compare_digest(expected_sig, x_hub_signature_256 or ""):
        raise UnauthorizedException("Invalid webhook signature")

    payload = await request.json()

    if x_github_event == "issues":
        await handle_issue_event(db, project_id, payload)
    elif x_github_event == "issue_comment":
        await handle_comment_event(db, project_id, payload)
```

### Event Handlers

```python
async def handle_issue_event(db: AsyncSession, project_id: str, payload: dict):
    action = payload["action"]
    issue = payload["issue"]
    issue_number = issue["number"]

    # Find BugSpark report linked to this GitHub issue
    report = await find_report_by_github_issue(db, project_id, issue_number)
    if not report:
        return  # Not a BugSpark-created issue

    if action == "closed":
        report.status = "resolved"
    elif action == "reopened":
        report.status = "new"
    elif action == "labeled":
        label = payload.get("label", {}).get("name", "")
        await sync_label_to_severity(report, label)
    elif action == "edited":
        # Optionally sync title/description changes back
        pass

    await db.commit()


async def handle_comment_event(db: AsyncSession, project_id: str, payload: dict):
    if payload["action"] != "created":
        return

    issue_number = payload["issue"]["number"]
    report = await find_report_by_github_issue(db, project_id, issue_number)
    if not report:
        return

    comment_body = payload["comment"]["body"]
    comment_author = payload["comment"]["user"]["login"]

    # Skip comments created by BugSpark (avoid infinite loop)
    if "[BugSpark]" in comment_body:
        return

    await create_synced_comment(
        db,
        report_id=report.id,
        content=f"**{comment_author}** (via GitHub):\n\n{comment_body}",
        source="github",
    )
```

### Report-Issue Linking

Add columns to Report model:

```python
# packages/api/app/models/report.py
github_issue_number = Column(Integer, nullable=True)
github_issue_url = Column(String(500), nullable=True)
github_repo = Column(String(200), nullable=True)  # "owner/repo"
```

When exporting to GitHub, save these fields:

```python
# In github_integration.py after creating issue:
report.github_issue_number = issue_data["number"]
report.github_issue_url = issue_data["html_url"]
report.github_repo = f"{owner}/{repo}"
```

### BugSpark → GitHub Comment Sync

When a comment is added in BugSpark on a report that has a linked GitHub issue:

```python
# In comments router, after creating comment:
if report.github_issue_number:
    background_tasks.add_task(
        sync_comment_to_github,
        project_id=report.project_id,
        issue_number=report.github_issue_number,
        comment_content=f"[BugSpark] {current_user.name}:\n\n{comment.content}",
    )
```

### Dashboard Changes

Update GitHub integration form to include:
- Webhook Secret field (auto-generated, displayed for copying)
- Instructions for setting up GitHub webhook
- Webhook URL to copy: `https://api.bugspark.hillmanchan.com/api/v1/webhooks/github/{project_id}`
- Events to subscribe: Issues, Issue comments
- Sync status indicator (last webhook received, sync health)

Update bug detail page:
- Show GitHub issue link badge (e.g., "REPO#123")
- Show sync status icon (synced / out of sync)
- Show which comments are synced from GitHub

## Implementation Steps

1. Add `github_issue_number`, `github_issue_url`, `github_repo` to Report model
2. Create Alembic migration
3. Update GitHub export to save issue link fields
4. Create `github_webhook.py` router
5. Implement HMAC-SHA256 signature verification
6. Implement issue event handler (close/reopen/label)
7. Implement comment sync (both directions)
8. Add `[BugSpark]` tag to outgoing comments to prevent loops
9. Add webhook secret generation to GitHub integration config
10. Update dashboard GitHub integration form with webhook setup instructions
11. Add sync status indicators to bug detail page

## Tests to Add

- `test_github_webhook_signature_verified`
- `test_github_issue_closed_resolves_report`
- `test_github_issue_reopened_reopens_report`
- `test_github_comment_synced_to_bugspark`
- `test_bugspark_comment_synced_to_github`
- `test_bugspark_tagged_comments_not_resynced` (prevent loops)
- `test_unlinked_issues_ignored`
- `test_invalid_signature_rejected`

## Status Mapping

| GitHub Issue State | BugSpark Status |
|-------------------|----------------|
| open | (no change on open) |
| closed | resolved |
| reopened | new |

| GitHub Label | BugSpark Severity |
|-------------|------------------|
| critical | critical |
| high-priority | high |
| medium-priority | medium |
| low-priority | low |
