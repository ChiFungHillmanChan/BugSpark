# 2.4 Chrome Browser Extension

## Priority: MEDIUM

Marker.io, Jam.dev, BugHerd, and Shake all have browser extensions. QA teams want to report bugs on any website without requiring the widget to be embedded. A free extension also serves as a user acquisition tool.

---

## Feature Scope

### MVP
- Chrome extension (Manifest V3)
- 1-click screenshot of current page
- Annotation tools (reuse from widget)
- Auto-capture: URL, viewport, user agent, console errors
- Submit report to BugSpark API
- Project selector (from user's projects)
- Login via PAT or browser auth

### Future
- Firefox extension
- Full console log capture (like widget)
- Network request capture
- Session recording snippet
- Pin-to-element feedback (like BugHerd)

## Architecture

### Extension Structure

```
packages/extension/
  manifest.json           # Manifest V3
  src/
    background/
      service-worker.ts   # Background service worker
    content/
      content-script.ts   # Injected into pages for screenshot/annotation
    popup/
      popup.html          # Extension popup UI
      popup.tsx            # React popup component
    options/
      options.html         # Extension settings page
      options.tsx           # React settings component
    shared/
      api-client.ts        # BugSpark API client (reuse from CLI)
      auth.ts              # Token storage (chrome.storage.local)
      types.ts             # Shared types
    annotation/
      # Reuse annotation code from packages/widget
      annotation-overlay.ts
      annotation-canvas.ts
      annotation-history.ts
  rollup.config.js         # Build config
  package.json
```

### manifest.json

```json
{
  "manifest_version": 3,
  "name": "BugSpark - Bug Reporter",
  "version": "1.0.0",
  "description": "Report bugs with screenshots, annotations, and auto-captured metadata",
  "permissions": [
    "activeTab",
    "storage",
    "tabs"
  ],
  "host_permissions": [
    "https://api.bugspark.dev/*"
  ],
  "action": {
    "default_popup": "popup.html",
    "default_icon": {
      "16": "icons/icon-16.png",
      "48": "icons/icon-48.png",
      "128": "icons/icon-128.png"
    }
  },
  "content_scripts": [{
    "matches": ["<all_urls>"],
    "js": ["content-script.js"],
    "run_at": "document_idle"
  }],
  "background": {
    "service_worker": "service-worker.js"
  }
}
```

### Popup UI Flow

```
1. User clicks extension icon
2. If not logged in → show login form (email/password or PAT)
3. If logged in → show project selector + "Report Bug" button
4. User clicks "Report Bug":
   a. Extension captures screenshot of active tab
   b. Opens annotation overlay on the page (via content script)
   c. User annotates, adds title/description/severity
   d. Submit → API
   e. Show success toast
```

### Sharing Code with Widget

The annotation tools can be shared between the widget and extension:

```
packages/shared/
  annotation/
    canvas.ts
    history.ts
    tools.ts
    types.ts
```

Or use a build-time copy/symlink approach:

```json
// packages/extension/package.json
{
  "scripts": {
    "prebuild": "cp -r ../widget/src/annotation ./src/annotation"
  }
}
```

### Authentication

```typescript
// packages/extension/src/shared/auth.ts

const STORAGE_KEY = "bugspark_auth";

interface AuthState {
  token: string;
  refreshToken: string;
  user: { id: string; email: string; name: string };
}

export async function getAuth(): Promise<AuthState | null> {
  const result = await chrome.storage.local.get(STORAGE_KEY);
  return result[STORAGE_KEY] || null;
}

export async function setAuth(auth: AuthState): Promise<void> {
  await chrome.storage.local.set({ [STORAGE_KEY]: auth });
}

export async function clearAuth(): Promise<void> {
  await chrome.storage.local.remove(STORAGE_KEY);
}
```

### Screenshot Capture

```typescript
// Using chrome.tabs API instead of html2canvas
async function captureScreenshot(): Promise<string> {
  const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
  const dataUrl = await chrome.tabs.captureVisibleTab(tab.windowId, {
    format: "png",
    quality: 90,
  });
  return dataUrl;
}
```

### Content Script (Annotation Overlay)

```typescript
// Injected into the page when user clicks "Annotate"
// Creates a full-page overlay with annotation canvas
// Reuses annotation tools from widget

chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.type === "START_ANNOTATION") {
    const overlay = createAnnotationOverlay(message.screenshotDataUrl);
    document.body.appendChild(overlay);
  }
});
```

## Implementation Steps

1. Create `packages/extension` directory structure
2. Extract shared annotation code into reusable module
3. Create Manifest V3 config
4. Implement popup UI (login, project selector, report form)
5. Implement screenshot capture via `chrome.tabs.captureVisibleTab`
6. Implement content script for annotation overlay
7. Implement API client (reuse patterns from CLI)
8. Implement auth storage via `chrome.storage.local`
9. Add metadata collection (URL, viewport, UA) via content script
10. Build pipeline (Rollup or Vite)
11. Test in Chrome
12. Publish to Chrome Web Store

## Distribution

- Chrome Web Store: $5 one-time developer fee
- Free for all users (including Free plan)
- Link from BugSpark dashboard and landing page

## Plan Gating

The extension itself is free. Plan limits apply to the underlying API:
- Free: 100 reports/month
- Starter+: Higher limits per plan

## Tests to Add

- Unit tests for API client
- Unit tests for auth storage
- Unit tests for metadata collection
- Integration test: full report submission flow
- Visual test: annotation overlay renders correctly
