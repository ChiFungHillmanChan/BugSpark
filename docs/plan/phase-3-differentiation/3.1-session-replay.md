# 3.1 Full Session Replay (rrweb)

## Priority: HIGH | Complexity: HIGH

Session replay is marked "Coming Soon" on all paid plans. LogRocket, Sentry, Contentsquare, and Userback all have mature session replay. The current 30-second sliding window is insufficient for debugging. Full session replay tied to bug reports is a major differentiator.

---

## Technology Choice: rrweb

[rrweb](https://github.com/rrweb-io/rrweb) is the industry-standard open-source session replay library. It records DOM mutations as a serializable event stream and replays them pixel-perfectly.

- MIT licensed
- ~50KB gzipped
- Used by PostHog, Highlight.io, and others
- Records DOM snapshots + incremental mutations (not video)
- Much more storage-efficient than video recording

## Feature Scope

### Recording (Widget)
- Integrate rrweb recorder into widget
- Record from page load or widget init
- Keep rolling buffer based on plan limit (30s / 2min / 5min)
- When user submits report, attach the buffered recording
- Upload recording data to storage (compressed JSON)

### Playback (Dashboard)
- Integrate rrweb-player into bug detail page
- Play back session with timeline scrubber
- Highlight user interactions (clicks, inputs)
- Sync with console logs and network requests on same timeline
- Speed controls (1x, 2x, 4x)

## Architecture

### Widget Changes

```typescript
// packages/widget/src/collectors/session-replay.ts

import { record } from 'rrweb';

class SessionReplayCollector {
  private events: any[] = [];
  private stopFn: (() => void) | null = null;
  private maxDurationMs: number;

  constructor(maxDurationMs: number = 120000) { // 2 min default
    this.maxDurationMs = maxDurationMs;
  }

  start(): void {
    this.stopFn = record({
      emit: (event) => {
        this.events.push(event);
        this.trimOldEvents();
      },
      sampling: {
        mousemove: 50,       // Sample mouse every 50ms
        mouseInteraction: true,
        scroll: 150,          // Sample scroll every 150ms
        input: 'last',        // Only record final input value
      },
      blockClass: 'bugspark-block',  // CSS class to block recording
      maskInputOptions: {
        password: true,
        email: false,
      },
      maskTextClass: 'bugspark-mask', // Mask sensitive text
    });
  }

  stop(): void {
    this.stopFn?.();
  }

  getEvents(): any[] {
    return [...this.events];
  }

  private trimOldEvents(): void {
    if (this.events.length < 2) return;
    const now = this.events[this.events.length - 1].timestamp;
    const cutoff = now - this.maxDurationMs;
    // Keep the initial full snapshot + events within window
    const firstFullSnapshot = this.events.findIndex(e => e.type === 2);
    this.events = this.events.filter((e, i) =>
      i <= firstFullSnapshot || e.timestamp >= cutoff
    );
  }
}
```

### Upload Flow

```typescript
// When user submits bug report:
async function submitReport(report: BugReport): Promise<void> {
  const replayEvents = sessionReplayCollector.getEvents();

  if (replayEvents.length > 0) {
    // Compress events
    const compressed = compress(JSON.stringify(replayEvents));

    // Upload to presigned URL
    const { uploadUrl, replayUrl } = await api.getReplayUploadUrl(report.projectKey);
    await fetch(uploadUrl, {
      method: 'PUT',
      body: compressed,
      headers: { 'Content-Type': 'application/octet-stream' },
    });

    report.sessionReplayUrl = replayUrl;
  }

  await api.submitReport(report);
}
```

### API Changes

New endpoint for replay upload:

```python
@router.post("/upload/replay")
async def get_replay_upload_url(
    api_key: str = Depends(validate_api_key),
):
    """Generate presigned URL for session replay upload."""
    key = f"replays/{uuid4()}.json.gz"
    upload_url = await storage_service.generate_presigned_upload(key, content_type="application/octet-stream")
    replay_url = await storage_service.generate_presigned_download(key)
    return {"uploadUrl": upload_url, "replayUrl": replay_url, "key": key}
```

Add to Report model:

```python
session_replay_url = Column(String(500), nullable=True)
session_replay_duration_ms = Column(Integer, nullable=True)
```

### Dashboard Replay Player

```typescript
// packages/dashboard/src/components/bug-detail/session-replay-player.tsx

import rrwebPlayer from 'rrweb-player';
import 'rrweb-player/dist/style.css';

function SessionReplayPlayer({ replayUrl }: { replayUrl: string }) {
  const containerRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    async function loadReplay() {
      const response = await fetch(replayUrl);
      const compressed = await response.arrayBuffer();
      const events = JSON.parse(decompress(compressed));

      new rrwebPlayer({
        target: containerRef.current!,
        props: {
          events,
          width: 800,
          height: 600,
          showController: true,
          speedOption: [1, 2, 4, 8],
          skipInactive: true,
        },
      });
    }
    loadReplay();
  }, [replayUrl]);

  return <div ref={containerRef} />;
}
```

## Plan-Based Duration Limits

| Plan | Max Recording Duration | Storage per Report |
|------|----------------------|-------------------|
| Free | None | N/A |
| Starter | 30 seconds | ~50-100KB |
| Pro | 2 minutes | ~200KB-1MB |
| Team | 5 minutes | ~500KB-2.5MB |
| Enterprise | Unlimited | Variable |

## Storage Cost Estimation

Assuming average 500KB per replay:
- 1,000 replays/month = 500MB = ~US$0.008/month (R2 pricing)
- 10,000 replays/month = 5GB = ~US$0.075/month
- 100,000 replays/month = 50GB = ~US$0.75/month

Storage cost is negligible. The main cost is bandwidth for playback.

## Privacy Considerations

- `maskInputOptions.password: true` — never record password inputs
- `blockClass: 'bugspark-block'` — developers can block specific elements
- `maskTextClass: 'bugspark-mask'` — mask sensitive text content
- Document these privacy controls in widget docs
- Add GDPR notice about session recording in widget UI

## Implementation Steps

1. Add `rrweb` dependency to widget package
2. Replace existing session recorder with rrweb-based collector
3. Add compression (pako/fflate) for replay data
4. Create replay upload API endpoint
5. Add `session_replay_url` and `session_replay_duration_ms` to Report model
6. Create Alembic migration
7. Create replay player component in dashboard (rrweb-player)
8. Add plan-based duration limits to widget config
9. Add privacy masking options to widget config
10. Update widget docs with session replay configuration
11. Add replay player to bug detail page
12. Add storage cleanup job for expired replays (based on retention period)

## Tests to Add

- `test_session_replay_collector_trims_old_events`
- `test_session_replay_respects_plan_duration`
- `test_replay_upload_generates_presigned_url`
- `test_replay_player_loads_and_renders`
- `test_session_replay_masks_passwords`
- `test_session_replay_blocks_marked_elements`

## Dependencies

- `rrweb` (~50KB gzipped) — recording
- `rrweb-player` — playback in dashboard
- `pako` or `fflate` — compression
