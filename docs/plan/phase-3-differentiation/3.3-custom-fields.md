# 3.3 Custom Fields Per Project

## Priority: MEDIUM | Complexity: MEDIUM

Small companies have unique needs: "Browser version", "Customer tier", "Feature area", "Environment (staging/prod)". Bugasura offers fully customizable fields. Custom fields make BugSpark adaptable to any workflow.

---

## Feature Scope

- Project owners define custom fields (text, select, number, checkbox)
- Widget displays custom fields in the report form
- Dashboard displays custom field values and allows filtering
- Custom fields are stored in the existing JSONB `metadata` column

## Architecture

### Custom Field Schema

```python
# packages/api/app/models/custom_field.py

class CustomFieldType(str, Enum):
    TEXT = "text"
    SELECT = "select"
    NUMBER = "number"
    CHECKBOX = "checkbox"
    URL = "url"

class CustomField(Base):
    __tablename__ = "custom_fields"

    id = Column(UUID, primary_key=True, default=uuid4)
    project_id = Column(UUID, ForeignKey("projects.id"), nullable=False)
    name = Column(String(100), nullable=False)       # "Environment"
    field_key = Column(String(100), nullable=False)   # "environment"
    field_type = Column(SQLEnum(CustomFieldType), nullable=False)
    required = Column(Boolean, default=False)
    options = Column(JSON, nullable=True)  # For select type: ["staging", "production"]
    default_value = Column(String(500), nullable=True)
    display_order = Column(Integer, default=0)
    show_in_widget = Column(Boolean, default=True)
    created_at = Column(DateTime, default=datetime.utcnow)

    # Unique constraint: one field_key per project
    __table_args__ = (UniqueConstraint("project_id", "field_key"),)
```

### API Endpoints

```
GET    /projects/{id}/custom-fields           -- List custom fields
POST   /projects/{id}/custom-fields           -- Create custom field
PATCH  /projects/{id}/custom-fields/{field_id} -- Update custom field
DELETE /projects/{id}/custom-fields/{field_id} -- Delete custom field
```

### Widget Integration

Custom fields are returned in the widget config endpoint:

```python
# Extend GET /projects/widget-config response
{
    "enableScreenshot": true,
    "primaryColor": "#e94560",
    "customFields": [
        {
            "key": "environment",
            "name": "Environment",
            "type": "select",
            "required": true,
            "options": ["staging", "production", "development"],
            "default": "production"
        },
        {
            "key": "browser_version",
            "name": "Browser Version",
            "type": "text",
            "required": false
        }
    ]
}
```

Widget renders custom fields dynamically in the report modal:

```typescript
// packages/widget/src/ui/report-modal.ts

function renderCustomFields(fields: CustomFieldConfig[]): HTMLElement[] {
    return fields.filter(f => f.showInWidget).map(field => {
        switch (field.type) {
            case 'text': return createTextInput(field);
            case 'select': return createSelectInput(field);
            case 'number': return createNumberInput(field);
            case 'checkbox': return createCheckboxInput(field);
            case 'url': return createUrlInput(field);
        }
    });
}
```

Custom field values are stored in the report's `metadata` JSONB column:

```json
{
    "custom_fields": {
        "environment": "production",
        "browser_version": "Chrome 120",
        "customer_tier": "enterprise"
    }
}
```

### Dashboard Changes

1. **Project Settings â†’ Custom Fields tab**
   - CRUD interface for managing custom fields
   - Drag-to-reorder display order
   - Preview of how fields appear in widget

2. **Bug Detail Page**
   - Show custom field values in metadata panel
   - Editable custom field values

3. **Bug List Page**
   - Filter by custom field values
   - Custom field columns in table view

## Implementation Steps

1. Create `CustomField` model
2. Create Alembic migration
3. Create custom fields CRUD API endpoints
4. Extend widget config endpoint to include custom fields
5. Update widget report modal to render custom fields
6. Update report creation to accept custom field values in metadata
7. Create custom fields management UI in project settings
8. Add custom field display to bug detail metadata panel
9. Add custom field filtering to bug list page
10. Add plan gating (Pro+)

## Plan Gating

| Plan | Custom Fields |
|------|--------------|
| Free | None |
| Starter | None |
| Pro | Up to 10 per project |
| Team | Up to 25 per project |
| Enterprise | Unlimited |

## Tests to Add

- `test_create_custom_field`
- `test_custom_field_unique_key_per_project`
- `test_widget_config_includes_custom_fields`
- `test_report_stores_custom_field_values`
- `test_filter_reports_by_custom_field`
- `test_custom_field_validation` (required, type check)
- `test_plan_limits_custom_field_count`
