# 4.1 SSO (SAML / OIDC)

## Priority: HIGH | Complexity: HIGH

Enterprise companies require SSO for security compliance. Without SSO, BugSpark cannot pass Enterprise procurement review.

---

## Feature Scope

### SAML 2.0
- Support IdPs: Okta, Azure AD, OneLogin, Google Workspace
- Service Provider (SP) initiated login
- IdP initiated login
- Just-in-time user provisioning
- Attribute mapping (email, name, role)

### OIDC (OpenID Connect)
- Support providers: Okta, Auth0, Azure AD, Google
- Authorization Code flow
- Auto-discovery via `.well-known/openid-configuration`

## Architecture

### SSO Configuration Model

```python
class SSOConfig(Base):
    __tablename__ = "sso_configs"

    id = Column(UUID, primary_key=True)
    organization_id = Column(UUID, ForeignKey("organizations.id"), unique=True)
    provider_type = Column(String(20))  # "saml" or "oidc"

    # SAML fields
    saml_entity_id = Column(String(500), nullable=True)
    saml_sso_url = Column(String(500), nullable=True)
    saml_certificate = Column(Text, nullable=True)

    # OIDC fields
    oidc_client_id = Column(String(200), nullable=True)
    oidc_client_secret = Column(String(500), nullable=True)  # Encrypted
    oidc_discovery_url = Column(String(500), nullable=True)

    # Common
    domain_whitelist = Column(ARRAY(String), nullable=True)  # e.g., ["company.com"]
    enforce_sso = Column(Boolean, default=False)  # Block password login
    auto_provision = Column(Boolean, default=True)
    default_role = Column(String(20), default="user")

    created_at = Column(DateTime, default=datetime.utcnow)
```

### Library Choice

Use `python3-saml` for SAML and `authlib` for OIDC:

```
pip install python3-saml authlib
```

### SSO Login Flow

```
1. User navigates to /login
2. Enters email → system checks if domain has SSO config
3. If SSO enforced → redirect to IdP
4. IdP authenticates → redirects back with SAML assertion or OIDC code
5. BugSpark validates assertion/code
6. Creates or updates user account (JIT provisioning)
7. Issues JWT tokens (same as regular login)
```

### API Endpoints

```
GET  /auth/sso/check?email=user@company.com  -- Check if SSO required
POST /auth/sso/saml/login                     -- Initiate SAML login
POST /auth/sso/saml/callback                  -- SAML assertion consumer
GET  /auth/sso/oidc/login                     -- Initiate OIDC login
GET  /auth/sso/oidc/callback                  -- OIDC authorization callback
GET  /admin/sso/config                        -- Get SSO config
PUT  /admin/sso/config                        -- Update SSO config
POST /admin/sso/test                          -- Test SSO connection
```

## Implementation Steps

1. Create `SSOConfig` model and migration
2. Add `python3-saml` and `authlib` dependencies
3. Implement SAML SP login and callback
4. Implement OIDC authorization code flow
5. Implement JIT user provisioning
6. Add SSO check endpoint (email domain → SSO redirect)
7. Update login page to check for SSO before showing password form
8. Create admin SSO configuration page
9. Add domain enforcement (block password login when SSO enforced)
10. Add SSO test endpoint
11. Document IdP setup guides (Okta, Azure AD, Google)

## Plan Gating

Enterprise plan only.
