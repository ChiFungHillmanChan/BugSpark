# 4.2 Audit Log

## Priority: HIGH | Complexity: MEDIUM

Enterprise companies need audit trails for compliance (SOC 2, ISO 27001, GDPR). Every significant action must be logged with who, what, when, and where.

---

## Events to Log

| Category | Events |
|----------|--------|
| Auth | login, logout, failed_login, password_change, token_create, token_revoke |
| User | user_create, user_update, user_delete, role_change, plan_change |
| Project | project_create, project_update, project_delete, key_rotate, member_add, member_remove |
| Report | report_create, report_update, report_delete, status_change, export_github, export_linear, export_jira |
| Integration | integration_create, integration_update, integration_delete |
| Admin | admin_user_update, admin_settings_change, beta_approve, beta_reject |
| SSO | sso_config_update, sso_login, sso_provision |

## Architecture

### Audit Log Model

```python
class AuditLog(Base):
    __tablename__ = "audit_logs"

    id = Column(UUID, primary_key=True, default=uuid4)
    timestamp = Column(DateTime, default=datetime.utcnow, index=True)
    user_id = Column(UUID, ForeignKey("users.id"), nullable=True)  # Null for system events
    user_email = Column(String(255), nullable=True)  # Denormalized for query convenience
    action = Column(String(100), nullable=False, index=True)  # e.g., "report.status_change"
    resource_type = Column(String(50), nullable=False)  # e.g., "report", "project", "user"
    resource_id = Column(String(100), nullable=True)
    project_id = Column(UUID, nullable=True, index=True)
    details = Column(JSON, nullable=True)  # Action-specific data
    ip_address = Column(String(45), nullable=True)
    user_agent = Column(String(500), nullable=True)
```

### Audit Service

```python
# packages/api/app/services/audit_service.py

async def log_action(
    db: AsyncSession,
    action: str,
    resource_type: str,
    resource_id: str | None = None,
    project_id: str | None = None,
    details: dict | None = None,
    user: User | None = None,
    request: Request | None = None,
):
    log = AuditLog(
        user_id=user.id if user else None,
        user_email=user.email if user else None,
        action=action,
        resource_type=resource_type,
        resource_id=resource_id,
        project_id=project_id,
        details=details,
        ip_address=request.client.host if request else None,
        user_agent=request.headers.get("user-agent") if request else None,
    )
    db.add(log)
    # Don't await commit — let the router's commit handle it
```

### Usage in Routers

```python
# Example: report status change
@router.patch("/reports/{report_id}")
async def update_report(...):
    old_status = report.status
    # ... update logic ...

    await log_action(
        db, action="report.status_change", resource_type="report",
        resource_id=str(report.id), project_id=str(report.project_id),
        details={"old_status": old_status, "new_status": report.status},
        user=current_user, request=request,
    )
```

### API Endpoints

```
GET /admin/audit-logs                  -- Platform-wide audit log (superadmin)
GET /projects/{id}/audit-logs          -- Project-level audit log (project admin)
```

Query parameters: `action`, `user_id`, `resource_type`, `date_from`, `date_to`, `page`, `limit`

### Dashboard UI

Admin → Audit Logs page:
- Filterable table with columns: Timestamp, User, Action, Resource, Details, IP
- Export to CSV
- Date range picker
- Action type filter
- User filter

## Implementation Steps

1. Create `AuditLog` model
2. Create Alembic migration
3. Create `audit_service.py`
4. Add `log_action` calls to all major router operations
5. Create admin audit log API endpoint
6. Create project-level audit log API endpoint
7. Create dashboard audit log page (admin section)
8. Add CSV export functionality
9. Add data retention policy (auto-delete logs older than X days based on plan)

## Plan Gating

Enterprise plan only. Logs retained for 1 year (configurable).

## Data Volume Consideration

- Estimate: 100-1000 audit events per day per active project
- Partition by month for query performance
- Index on (timestamp, action, project_id)
- Consider archiving old logs to cold storage after retention period
