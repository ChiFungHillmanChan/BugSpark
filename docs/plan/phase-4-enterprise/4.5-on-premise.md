# 4.5 On-Premise Deployment

## Priority: LOW | Complexity: HIGH

Some enterprise customers (banks, government, healthcare) cannot use cloud services due to regulatory requirements. Offering a self-hosted option opens these markets.

---

## Feature Scope

- Docker Compose-based deployment package
- Single command to deploy entire BugSpark stack
- All data stays on customer's infrastructure
- Customer manages their own PostgreSQL, S3-compatible storage, and SMTP
- Admin panel for configuration
- License key validation

## Architecture

### Deployment Package

```
bugspark-self-hosted/
  docker-compose.yml          # Full stack
  .env.example                # Configuration template
  nginx/
    nginx.conf                # Reverse proxy config
  scripts/
    setup.sh                  # Interactive setup script
    backup.sh                 # Database backup
    restore.sh                # Database restore
    update.sh                 # Pull new images and migrate
  docs/
    installation.md
    configuration.md
    upgrading.md
    troubleshooting.md
```

### docker-compose.yml

```yaml
services:
  api:
    image: ghcr.io/bugspark/api:latest
    environment:
      - DATABASE_URL=postgresql+asyncpg://...
      - JWT_SECRET=${JWT_SECRET}
      - S3_ENDPOINT_URL=${S3_ENDPOINT_URL}
      # ... all config from .env
    depends_on:
      - postgres
      - minio

  dashboard:
    image: ghcr.io/bugspark/dashboard:latest
    environment:
      - NEXT_PUBLIC_API_URL=http://api:8000

  postgres:
    image: postgres:16
    volumes:
      - pgdata:/var/lib/postgresql/data

  minio:
    image: minio/minio
    volumes:
      - miniodata:/data
    command: server /data --console-address ":9001"

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./certs:/etc/nginx/certs

volumes:
  pgdata:
  miniodata:
```

### License Key System

```python
# Simple license validation
class LicenseValidator:
    def validate(self, license_key: str) -> LicenseInfo:
        # Decode and verify signed license
        # Check expiry, seat count, feature flags
        pass

class LicenseInfo:
    customer: str
    max_seats: int
    max_projects: int
    features: list[str]
    expires_at: datetime
```

### Update Mechanism

```bash
#!/bin/bash
# scripts/update.sh
docker compose pull
docker compose up -d
docker compose exec api alembic upgrade head
echo "Update complete!"
```

## Implementation Steps

1. Create multi-stage Dockerfiles for API and Dashboard
2. Create Docker Compose configuration
3. Create setup script (interactive .env configuration)
4. Create Nginx reverse proxy config with SSL
5. Create backup/restore scripts
6. Implement license key validation
7. Create installation documentation
8. Set up GitHub Container Registry (GHCR) for image publishing
9. Create update mechanism
10. Test full deployment on clean VM

## Pricing

Self-hosted Enterprise: Custom pricing based on seats and support level.
Typical range: US$500-2,000/month depending on organization size.

## Considerations

- Need a release process for building and pushing Docker images
- Customer needs to provide their own Anthropic API key for AI features
- Consider offering a "BugSpark Cloud for Enterprise" alternative (dedicated instance)
- Support SLA requirements for on-premise customers
